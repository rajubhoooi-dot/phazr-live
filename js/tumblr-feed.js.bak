console.log("PHAZR JS - VIDEOS + INFINITE BLOGS/TAGS");

// ==== CONFIG ====
const LIMIT = 20;
let currentBlog = 'all';
let currentTag = '';
let offset = 0;
let isLoading = false;
let hasMore = true;
const loadedIds = new Set();
let allPosts = [];
const feedEl = document.getElementById('feed');
const sidebar = document.getElementById('sidebar');
const menuBtn = document.getElementById('menuBtn');
let loaderEl = null;

const POPULAR_BLOGS = ["2face2","appreciation6","aztepayatl","anna-lisachristiane","alexmucciblog","baddiesdaily","beautifulwomen8910","curvesheaven","demirose-model-blog","elifmusa","goslowhand","lacikaysomersfanclub","marynabokova","valerie-cossett"];
const FAVORITE_TAGS = ["love", "art", "fashion", "aesthetic", "cute", "model", "beauty"];

// ==== CACHING ====
function getCached(k) { const c = localStorage.getItem(k); if (!c) return null; const {d, t} = JSON.parse(c); if (Date.now() - t > 3600000) { localStorage.removeItem(k); return null; } return d; }
function setCached(k, d) { localStorage.setItem(k, JSON.stringify({d, t: Date.now()})); }

// ==== LOADER ====
function createLoader() { if (loaderEl) return; loaderEl = document.createElement('div'); loaderEl.className = 'loader'; loaderEl.innerHTML = 'Loading...'; loaderEl.style.cssText = 'text-align:center;padding:20px;color:#d32f2f;font-size:14px;'; feedEl.appendChild(loaderEl); }
function removeLoader() { if (loaderEl && loaderEl.parentNode) { loaderEl.parentNode.removeChild(loaderEl); loaderEl = null; } }

// ==== RESET ====
function resetFeed() { feedEl.innerHTML = ''; offset = 0; hasMore = true; loadedIds.clear(); allPosts = []; removeLoader(); }

// ==== FETCH FUNCTIONS ====
async function fetchAllBlogs() {
  if (isLoading || !hasMore) return;
  isLoading = true; createLoader();
  const url = `/blogs/all/posts?offset=${offset}&limit=50`;
  let newPosts = getCached(`all_${offset}`);
  if (!newPosts) {
    try {
      const r = await fetch(url);
      if (!r.ok) throw new Error();
      const d = await r.json();
      newPosts = (d.posts || []).filter(p => !loadedIds.has(p.id)).map(p => {
        loadedIds.add(p.id);
        return { id: p.id, src: p.src, type: p.type, video_url: p.video_url, user: 'PHAZR', likes: p.note_count || 0 };
      });
      if (newPosts.length) setCached(`all_${offset}`, newPosts);
    } catch (e) { newPosts = []; }
  }
  allPosts = offset === 0 ? newPosts : [...allPosts, ...newPosts];
  offset += newPosts.length;
  hasMore = newPosts.length > 0;
  isLoading = false; removeLoader();
  renderPosts(allPosts);
}

async function fetchFromBlog(blog) {
  if (isLoading || !hasMore) return;
  isLoading = true; createLoader();
  const url = `/blog/${blog}/posts?offset=${offset}&limit=${LIMIT}`;
  let newPosts = getCached(`blog_${blog}_${offset}`);
  if (!newPosts) {
    try {
      const r = await fetch(url);
      if (!r.ok) throw new Error();
      const d = await r.json();
      newPosts = (d.posts || []).filter(p => !loadedIds.has(p.id)).map(p => {
        loadedIds.add(p.id);
        return { id: p.id, src: p.src, type: p.type, video_url: p.video_url, user: 'PHAZR', likes: p.note_count || 0 };
      });
      if (newPosts.length) setCached(`blog_${blog}_${offset}`, newPosts);
    } catch (e) { newPosts = []; }
  }
  allPosts = offset === 0 ? newPosts : [...allPosts, ...newPosts];
  offset += newPosts.length;
  hasMore = newPosts.length > 0;
  isLoading = false; removeLoader();
  renderPosts(allPosts);
}

async function fetchTaggedPosts(tag) {
  if (isLoading || !hasMore) return;
  isLoading = true; createLoader();
  const url = `/tag/${tag}?offset=${offset}&limit=${LIMIT}`;
  let newPosts = getCached(`tag_${tag}_${offset}`);
  if (!newPosts) {
    try {
      const r = await fetch(url);
      if (!r.ok) throw new Error();
      const d = await r.json();
      newPosts = (d.posts || []).filter(p => !loadedIds.has(p.id)).map(p => {
        loadedIds.add(p.id);
        return { id: p.id, src: p.src, type: p.type, video_url: p.video_url, user: 'PHAZR', likes: p.note_count || 0 };
      });
      if (newPosts.length) setCached(`tag_${tag}_${offset}`, newPosts);
    } catch (e) { newPosts = []; }
  }
  allPosts = offset === 0 ? newPosts : [...allPosts, ...newPosts];
  offset += newPosts.length;
  hasMore = newPosts.length > 0;
  isLoading = false; removeLoader();
  renderPosts(allPosts);
}

// ==== RENDER POSTS (VIDEO + IMAGE) ====
function renderPosts(posts) {
  if (offset === 0) feedEl.innerHTML = '';

  posts.forEach(p => {
    if (document.querySelector(`[data-id="${p.id}"]`)) return;

    const post = document.createElement('article');
    post.className = 'post';
    post.dataset.id = p.id;

    let mediaHTML = '';
    if (p.type === 'video' && p.video_url) {
      mediaHTML = `<video src="${p.video_url}" loop muted playsinline preload="metadata" style="width:100%;height:auto;display:block;background:#000;"></video>`;
    } else {
      const imgSrc = p.src || 'https://via.placeholder.com/700?text=No+Image';
      mediaHTML = `<img src="${imgSrc}" loading="lazy" style="width:100%;height:auto;display:block;" onerror="this.src='https://via.placeholder.com/700?text=No+Image'">`;
    }

    post.innerHTML = `
      <div class="post-header">
        <img src="https://via.placeholder.com/32/333/fff?text=P" alt="PHAZR">
        <strong>PHAZR</strong>
      </div>
      <div class="post-media" style="position:relative;cursor:pointer;">
        ${mediaHTML}
        <img src="logo.png" alt="PHAZR Logo" style="position:absolute;top:12px;left:12px;width:40px;height:40px;object-fit:contain;z-index:10;pointer-events:none;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.2);">
        <div class="double-tap-heart" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:80px;opacity:0;pointer-events:none;color:white;text-shadow:0 0 10px rgba(0,0,0,0.5);transition:opacity 0.3s;">[heart]</div>
      </div>
      <div class="post-actions" style="padding:8px 12px;display:flex;align-items:center;gap:12px;">
        <button class="ig-like-btn" style="background:none;border:none;cursor:pointer;font-size:24px;"><i class="far fa-heart"></i></button>
        <span class="like-count" style="font-weight:600;">${(p.likes || 0).toLocaleString()}</span>
      </div>
      <div class="post-caption" style="padding:0 12px 12px;font-size:14px;">
        <strong>PHAZR</strong> READ ROMANTIC STORIES AT BOTTOM [heart] .ENJOY!!
      </div>
    `;

    // === LIKE LOGIC ===
    const media = post.querySelector('.post-media');
    const heartIcon = post.querySelector('.ig-like-btn i');
    const floatingHeart = post.querySelector('.double-tap-heart');
    const likeCount = post.querySelector('.like-count');
    let liked = false;

    const triggerLike = () => {
      if (liked) return;
      liked = true;
      heartIcon.classList.replace('far', 'fas');
      heartIcon.style.color = '#e1306c';
      floatingHeart.style.opacity = '1';
      setTimeout(() => floatingHeart.style.opacity = '0', 800);
      let count = parseInt(likeCount.textContent.replace(/,/g, '')) || 0;
      count++;
      likeCount.textContent = count.toLocaleString();
    };

    media.addEventListener('dblclick', triggerLike);
    post.querySelector('.ig-like-btn').addEventListener('click', e => { e.stopPropagation(); triggerLike(); });

    // === VIDEO AUTOPLAY ===
    if (p.type === 'video') {
      const video = post.querySelector('video');
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) video.play().catch(() => {});
          else video.pause();
        });
      }, { threshold: 0.6 });
      observer.observe(video);
    }

    feedEl.appendChild(post);
  });
}

// ==== SIDEBAR & INFINITE SCROLL ====
(() => {
  const blogLinks = document.getElementById('blogLinks');
  const allLink = document.createElement('a'); allLink.href = '#'; allLink.textContent = 'ALL';
  allLink.onclick = e => { e.preventDefault(); currentBlog = 'all'; currentTag = ''; resetFeed(); fetchAllBlogs(); sidebar.classList.remove('visible'); };
  blogLinks.appendChild(allLink);

  POPULAR_BLOGS.forEach(b => {
    const a = document.createElement('a'); a.href = '#'; a.textContent = b;
    a.onclick = e => { e.preventDefault(); currentBlog = b; currentTag = ''; resetFeed(); fetchFromBlog(b); sidebar.classList.remove('visible'); };
    blogLinks.appendChild(a);
  });

  FAVORITE_TAGS.forEach(t => {
    const a = document.createElement('a'); a.href = '#'; a.textContent = `#${t}`; a.style.color = '#d32f2f';
    a.onclick = e => { e.preventDefault(); currentTag = t; currentBlog = ''; resetFeed(); fetchTaggedPosts(t); sidebar.classList.remove('visible'); };
    blogLinks.appendChild(a);
  });
})();

// Search
document.getElementById('searchInput')?.addEventListener('keypress', e => { if (e.key === 'Enter') triggerSearch(e.target.value.trim()); });
document.querySelector('.search-bar .fa-search')?.addEventListener('click', () => triggerSearch(document.getElementById('searchInput').value.trim()));
function triggerSearch(q) {
  if (!q) return;
  const isTag = q.startsWith('#');
  const clean = isTag ? q.slice(1).toLowerCase() : q.toLowerCase();
  if (isTag) { currentTag = clean; currentBlog = ''; resetFeed(); fetchTaggedPosts(clean); }
  else { currentBlog = clean; currentTag = ''; resetFeed(); fetchFromBlog(clean); }
  sidebar.classList.remove('visible');
}

// Menu
menuBtn.addEventListener('click', e => { e.stopPropagation(); sidebar.classList.toggle('visible'); });
document.getElementById('closeSidebar')?.addEventListener('click', e => { e.stopPropagation(); sidebar.classList.remove('visible'); });
document.addEventListener('click', e => {
  if (sidebar.classList.contains('visible') && !sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
    sidebar.classList.remove('visible');
  }
});

// Infinite Scroll
const sentinel = document.createElement('div'); sentinel.id = 'sentinel'; sentinel.style.height = '20px'; document.body.appendChild(sentinel);
new IntersectionObserver(([e]) => {
  if (e.isIntersecting && !isLoading && hasMore) {
    if (currentTag) fetchTaggedPosts(currentTag);
    else if (currentBlog === 'all') fetchAllBlogs();
    else fetchFromBlog(currentBlog);
  }
}, { threshold: 0.1 }).observe(sentinel);

// Start
resetFeed();
setTimeout(() => fetchAllBlogs(), 500);
